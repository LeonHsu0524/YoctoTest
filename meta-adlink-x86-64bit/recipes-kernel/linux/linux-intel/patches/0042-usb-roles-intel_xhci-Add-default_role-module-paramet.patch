From 553c0b72bb1bc4d55e80d52f1bba2edf796a7c9a Mon Sep 17 00:00:00 2001
From: Wan Ahmad Zainie <wan.ahmad.zainie.wan.mohamad@intel.com>
Date: Fri, 21 Sep 2018 16:33:52 +0800
Subject: [PATCH 42/42] usb: roles: intel_xhci: Add default_role module
 parameter

This patch adds default_role module parameter for
intel_xhci_usb_role_switch.ko. This will allow people to override
default role set by BIOS when XDCI Support is set to PCI Mode.

Signed-off-by: Wan Ahmad Zainie <wan.ahmad.zainie.wan.mohamad@intel.com>
---
 drivers/usb/roles/intel-xhci-usb-role-switch.c | 14 ++++++++++++++
 1 file changed, 14 insertions(+)

diff --git a/drivers/usb/roles/intel-xhci-usb-role-switch.c b/drivers/usb/roles/intel-xhci-usb-role-switch.c
index dad2d19..0d33458 100644
--- a/drivers/usb/roles/intel-xhci-usb-role-switch.c
+++ b/drivers/usb/roles/intel-xhci-usb-role-switch.c
@@ -59,6 +59,10 @@ static acpi_status intel_xhci_userspace_ctrl(acpi_handle handle, u32 level,
 	return AE_OK;
 }
 
+static int default_role;
+module_param(default_role, int, 0444);
+MODULE_PARM_DESC(default_role, "USB OTG port default role 0:default 1:host 2:device");
+
 static int intel_xhci_usb_set_role(struct device *dev, enum usb_role role)
 {
 	struct intel_xhci_usb_data *data = dev_get_drvdata(dev);
@@ -171,6 +175,16 @@ static int intel_xhci_usb_probe(struct platform_device *pdev)
 	msleep(10);
 	intel_xhci_usb_set_role(dev, USB_ROLE_DEVICE);
 
+	/* Override USB OTG port default role. */
+	switch (default_role) {
+	case USB_ROLE_HOST:
+		intel_xhci_usb_set_role(dev, USB_ROLE_HOST);
+		break;
+	case USB_ROLE_DEVICE:
+		intel_xhci_usb_set_role(dev, USB_ROLE_DEVICE);
+		break;
+	}
+
 	return 0;
 }
 
-- 
1.9.1

